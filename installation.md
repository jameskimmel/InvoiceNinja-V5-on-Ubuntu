This is a basic tutorial for a default installation of a InvoiceNinja instance on Ubuntu 24.04 LTS

update and upgrade 
```bash
sudo apt update && sudo apt upgrade -y
```

install dependencies  
At the time of writing this, Ubuntu 22.04 uses PHP 8.1
Since InvoiceNinja v5.9.0, at least PHP 8.2 is needed. 

We need to add Ondrej PHP Package to get a newer PHP Version.
PHP 8.3.7 is the current version for June 2024. Invoice Ninja currently supports 8.2 



```bash
sudo add-apt-repository ppa:ondrej/php -y
sudo apt update
```

install php
```bash
sudo apt install php-fpm -y
```

install php extensions
```bash
sudo apt install php-{bcmath,mbstring,xml,curl,zip,gmp,gd,mysql} -y
```

check PHP. Should show PHP8.3
```bash
php -v
```

increase memory limit of php
```bash
sudo nano /etc/php/8.3/fpm/php.ini 
```
change the line
```bash
memory_limit = 1024M
```

install dependencies  
```bash
sudo apt install mariadb-server curl git nginx composer -y
```
if we visit http://yourIP , you should see the nginx welcome page. https://yourIP will not work you need to use http instead of https for now!

make sure there is no Apache2 running
```bash
sudo systemctl stop apache2
sudo systemctl disable apache2
```

enable nginx at boot and also start now
```bash
sudo systemctl enable --now nginx
```

delete the nginx default site and reload. The welcome page should now be gone
```bash
sudo rm /etc/nginx/sites-enabled/default
sudo nginx -s reload
```

Check if php-fpm is running. You should see something like active: active (running)
```bash
sudo systemctl status php8.3-fpm.service
```
press q to quit

enable mariadb and start it 
```bash
sudo systemctl enable --now mariadb
```
This command will take you through a guided wizard to initialize the SQL database. Use default values written in capital letters
```bash
sudo mysql_secure_installation
```
Enter, 
Enter, 
Enter,
insert a password for the root account, 
repeat the password, 
Enter, 
Enter, 
Enter, 
Enter. 
You should see "Thanks for using MariaDB"

login to the database
```bash
sudo mysql -u root -p
```
enter the password you just set

you should see MariaDB [(none)]> on the left of your cursor

create database ninjadb
```mysql
CREATE SCHEMA `ninjadb` DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
```
You should see Query OK, 1 row affected

create the user ninja and set a Password
```mysql
CREATE USER 'ninja'@'localhost' IDENTIFIED BY 'Password';
```
You should see Query OK, 0 rows affected

give all permissions for to the local ninja user to access ninjadb
```mysql
GRANT ALL PRIVILEGES ON ninjadb.* TO 'ninja'@'localhost';
```
You should see Query OK, 0 rows affected

reload privileges
```mysql
FLUSH PRIVILEGES;
```
You should see Query OK, 0 rows affected

exit the db
```mysql
exit
```
You should see Bye

   
create config for webpage
```bash
sudo nano /etc/nginx/sites-available/invoiceninja.conf
```
insert this:
```NGINX
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /usr/share/nginx/invoiceninja/public;


        # Add index.php to the list if you are using PHP
        index index.html index.htm index.php;

	charset utf-8;
	client_max_body_size 20M;

	#gzip on;
	#gzip_types application/javascript application/x-javascript text/javascript text/plain application/xml application/json;
	#gzip_proxied    no-cache no-store private expired auth;
	#gzip_min_length 1000;        

	server_name _;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }

        # pass PHP scripts to FastCGI server
        
        location ~ \.php$ {
               include snippets/fastcgi-php.conf;
        
               # With php-fpm (or other unix sockets):
               fastcgi_pass unix:/run/php/php-fpm.sock;
               # With php-cgi (or other tcp sockets):
        #       fastcgi_pass 127.0.0.1:9000;
        }

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        location ~ /\.ht {
               deny all;
        }

	location ~* \.pdf$ {
		add_header Cache-Control no-store;
	}

	if (!-e $request_filename) {
		rewrite ^(.+)$ /index.php?q= last;
	}

	location = /favicon.ico { 
		access_log off; log_not_found off; 
	}

	location = /robots.txt {
		access_log off; log_not_found off; 
	}

}

```
save and exit

This config example listenes to all server names (because it will be put behind a proxy) but you can set a
server name instead of "_". For example you could use ninja.yourdomain.com

Check if syntax of your file is ok
```bash
sudo nginx -t
```

make install dir
```bash
sudo mkdir /usr/share/nginx/invoiceninja && cd /usr/share/nginx/invoiceninja
```
Find latest version here https://github.com/invoiceninja/invoiceninja/releases
Right click the link to the zip file and copy the download link

Download the zip
```bash
sudo wget https://github.com/invoiceninja/invoiceninja/releases/download/v5.9.1/invoiceninja.zip
```
unzip and remove the zip file
```bash
sudo unzip invoiceninja.zip && sudo rm invoiceninja.zip
```

if you wanna use snappdf instead of the cloud service phantomPDF, we need some
dependancies for snappdf
more info https://github.com/beganovich/snappdf#headless-chrome-doesnt-launch-on-unix
```bash
sudo apt install ca-certificates fonts-liberation libappindicator3-1 libasound2t64 libatk-bridge2.0-0t64 libatk1.0-0 libc6 libcairo2 libcups2t64 libdbus-1-3 libexpat1 libfontconfig1 libgbm1 libgcc-s1 libglib2.0-0t64 libgtk-3-0t64 libnspr4 libnss3 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 lsb-release wget xdg-utils libgbm-dev libxshmfence-dev
```
Copy the example .env 
```bash
sudo cp /usr/share/nginx/invoiceninja/.env.example /usr/share/nginx/invoiceninja/.env
```
Now we need to edit your .env file.
For now, you only need to edit one line (or two if you have a reverse proxy like me) 
Everything else we can setup later in the webgui setup. I added some hashtag comments above the line(s) you need to change.

```bash
sudo nano /usr/share/nginx/invoiceninja/.env
```

```bash
APP_NAME="Invoice Ninja"
APP_ENV=production
APP_KEY=base64:RR++yx2rJ9kdxbdh3+AmbHLDQu+Q76i++co9Y8ybbno=
APP_DEBUG=false

APP_URL=http://localhost
REACT_URL=http://localhost:3001

DB_CONNECTION=mysql
MULTI_DB_ENABLED=false

DB_HOST=localhost
DB_DATABASE=ninja
DB_USERNAME=ninja
DB_PASSWORD=ninja
DB_PORT=3306

DEMO_MODE=false

BROADCAST_DRIVER=log
LOG_CHANNEL=stack
CACHE_DRIVER=file
QUEUE_CONNECTION=sync
SESSION_DRIVER=file
SESSION_LIFETIME=120

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

POSTMARK_API_TOKEN=
REQUIRE_HTTPS=false

GOOGLE_MAPS_API_KEY=
ERROR_EMAIL=
# I set this to the IPv4 of my reverse proxy.
TRUSTED_PROXIES=10.0.25.10

NINJA_ENVIRONMENT=selfhost

# this you need to set to snappdf
#options - snappdf / phantom / hosted_ninja
PDF_GENERATOR=snappdf

PHANTOMJS_KEY='a-demo-key-with-low-quota-per-ip-address'
PHANTOMJS_SECRET=secret

UPDATE_SECRET=secret

DELETE_PDF_DAYS=60
DELETE_BACKUP_DAYS=60

COMPOSER_AUTH='{"github-oauth": {"github.com": "${{ secrets.GITHUB_TOKEN }}"}}'

GOOGLE_PLAY_PACKAGE_NAME=
APPSTORE_PASSWORD=

MICROSOFT_CLIENT_ID=
MICROSOFT_CLIENT_SECRET=
MICROSOFT_REDIRECT_URI=

APPLE_CLIENT_ID=
APPLE_CLIENT_SECRET=
APPLE_REDIRECT_URI=

NORDIGEN_SECRET_ID=
NORDIGEN_SECRET_KEY=

```
save and exit

set permissions to the nginx user
```bash
sudo chown -R www-data:www-data /usr/share/nginx/invoiceninja
```
edit crontab to run Laravel Scheduler every minute
```bash
sudo -u www-data crontab -e
```
insert this at the end:
```bash
* * * * * cd /usr/share/nginx/invoiceninja/ && php artisan schedule:run >> /dev/null 2>&1
```
save and exit

enable webpage
```bash
sudo ln -s /etc/nginx/sites-available/invoiceninja.conf /etc/nginx/sites-enabled/
```

Check if everythin is good
```bash
sudo nginx -t
```
reload nginx
```bash
sudo nginx -s reload
```


The next steps are very much dependant if you use InvoiceNinja behind a proxy or not or if you only use invoiceninja local without a cert.  

If you don't use https, you don't have to do anything.  
If you don't use it behind a proxy, you need to install certbot on the InvoiceNinja host.  
If you use it behind a proxy, you configure certbot on the proxy  


visit our http://ipofyourhost/setup address to setup InvoiceNinja  

For URL you set the desired URL or the IP address if you use only local without SSL.    
HTTPS should be require unless you use a reverse proxy.  
Test PDF should show success.  

Insert the database credentials  
```bash
localhost
3306
ninjadb
ninja
```
and the password you set during the DB setup. If you just copied my steps, this would be "Password".    

Test PDF should show success.  

Create a User Account, agree to the terms and click submit  
Now this could take some time. You should be redirected to the URL you defined earlier.  
Don't leave the page and have some patience. If the page is just gray, try to disable pihole or any other adblockers.  

If your browser redirected you to https, you need to setup certbot first before you try to login.  

This is it. You are done and hopefully everything is up and running! You can follow the optional steps below if you wan't,
but a basic local none encrypted version sould be up and running now. 


Optional: Installing certbot to get a valid cert  

install snapd  
```bash
sudo apt install snapd
```
update snapd
```bash
sudo snap install core
sudo snap refresh core
```
install certbot
```bash
sudo snap install --classic certbot
```
create a cert
```bash
sudo certbot --nginx
```
this will lead you trough the setup process. If something fails, it is probably because you forgot to set the public dns or your firewall blocks port 80 to certbot
Anyway, there are a lot of good tutorials online how to setup certbot.
Certbot automatically changes your NGINX .conf file to listen on port 443

if you run invoiceninja behind a proxy, here is a sample config.
otherwise you can ignore this
```bash
server {
    server_name ninja.domain.com;

    listen       80;
    listen      [::]:80;

    # This is important or you will get 413 Server error from the proxy side
    client_max_body_size 20M;

    location / {
                    proxy_set_header        Host $host;
                    proxy_set_header        X-Real-IP $remote_addr;
                    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header        X-Forwarded-Proto $scheme;
                    proxy_buffering         off;
                    proxy_request_buffering off;
                    proxy_pass_header       Server;
                    # Enter the IP or Internal DNS name of the server Invoice Ninja is installed on
                    proxy_pass              http://10.0.1.2/;
                    proxy_redirect          off;
                    #add_header Strict-Transport-Security "max-age=15552000; includeSubDomains" always;
                    }





}


```


Optional: optimize the artisan queque
For better performance you can install supervisor.
More info here: https://invoiceninja.github.io/en/self-host-installation/#add-the-cron-job

Disable the old crontab by deleting it. 
```bash
sudo -u www-data crontab -e
```


Install and configure supervisor
```bash
sudo apt-get install supervisor  
cd /etc/supervisor/conf.d  
cd /etc/supervisor/conf.d  
sudo nano invoiceninja-worker.conf
```
insert this
```bash
[program:invoiceninja-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /usr/share/nginx/invoiceninja/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=8
redirect_stderr=true
stdout_logfile=/var/log/invoiceninja-worker.log
stopwaitsecs=3600
```
Then do
```bash
cd /var/log
sudo touch invoiceninja-worker.log
sudo chown www-data:www-data invoiceninja-worker.log
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start invoiceninja-worker:*
sudo supervisorctl status
sudo nano /usr/share/nginx/invoiceninja/.env
```
insert this
```bash
QUEUE_CONNECTION=database

cd /usr/share/nginx/invoiceninja/
sudo -u www-data php artisan optimize
sudo -u www-data php artisan queue:restart
```
Done :)
